<!doctype html><meta charset="utf-8" />
<title>SimpleSepAI ‚Äì Fallback Demo</title>
<style>
  :root { --bg:#0b0c10; --card:#121318; --muted:#99a3ad; --accent:#3aa6ff; --success:#6fe7a5; --warning:#ffaa00; --error:#ff7780; }
  body { margin:0; font-family: system-ui, sans-serif; color:#e9eef5; background:var(--bg); }
  .layout { display:grid; grid-template-columns: 300px 1fr; min-height:100vh; }
  .sidebar { background:#0f1116; border-right:1px solid #1b1f2a; padding:16px; }
  .main { display:flex; flex-direction:column; }
  h1 { font-size:20px; margin:16px; }
  .section-title { font-size:12px; color:var(--muted); margin:12px 0 6px; letter-spacing:.05em; text-transform:uppercase; }
  .btn { display:block; width:100%; text-align:left; padding:10px 12px; margin:6px 0; background:#141724; border:1px solid #1e2230; border-radius:10px; color:#dce3ec; cursor:pointer; }
  .btn:hover { border-color:#2c3246; background:#171b2b; }
  .btn:active { background:#1a1e2e; }
  .tag { font-size:11px; color:#a9b3bf; margin-left:6px; }
  .content { padding:16px; }
  .cards { display:grid; grid-template-columns: repeat(auto-fill,minmax(350px,1fr)); gap:16px; }
  .card { background:var(--card); border:1px solid #1b2030; border-radius:14px; padding:16px; }
  .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0; }
  .status { font-size:12px; padding:4px 8px; border-radius:6px; }
  .status.ok { background:#1a3a2a; color:#6fe7a5; }
  .status.fail { background:#3a1a1a; color:#ff7780; }
  .status.running { background:#3a2a1a; color:#ffaa00; }
  .log { background:#0c0e13; border:1px solid #1b2030; border-radius:12px; padding:12px; height:400px; overflow:auto; white-space:pre-wrap; font-family:monospace; font-size:12px; }
  .idea { background:#0c1019; border:1px dashed #263149; border-radius:12px; padding:12px; margin:8px 0; }
  .idea + .idea { margin-top:8px; }
  .source-badge { font-size:10px; padding:2px 6px; border-radius:4px; margin-left:8px; }
  .source-badge.openai { background:#1a3a2a; color:#6fe7a5; }
  .source-badge.grok { background:#2a1a3a; color:#c77dff; }
  .source-badge.fallback { background:#3a2a1a; color:#ffaa00; }
  .source-badge.error { background:#3a1a1a; color:#ff7780; }
  .meta-info { font-size:11px; color:#99a3ad; margin-top:4px; }
</style>
<script>
  const API = "http://127.0.0.1:8000";
  async function getJSON(p){ const r=await fetch(API+p); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function postJSON(p, body){ const r=await fetch(API+p,{method:"POST",headers:{"Content-Type":"application/json"},body:body?JSON.stringify(body):null}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  async function runIdeaUnitTest() {
    setStatus("test-idea", "running");
    try {
      const res = await postJSON("/api/run_test/idea");
      appendLog("Test", JSON.stringify(res, null, 2));
      setStatus("test-idea", res.status === "PASS" ? "ok" : "fail");
      if (res.summary_file) document.getElementById("summary-path").textContent = res.summary_file;
    } catch (e) { appendLog("Test", "Fehler: " + e); setStatus("test-idea", "fail"); }
  }

  async function fetchIdea() {
    setStatus("test-research", "running");
    try {
      const res = await postJSON("/api/research/idea", {risk:3, budget_sol:0.1, provider:"auto"});
      addIdea(res);
      appendLog("API", `Quelle: ${res.source} | Retries: ${res.retries || 0} | Dauer: ${res.duration_ms || 0}ms`);
      if (res.error) appendLog("API", `Fehler: ${res.error}`);
      setStatus("test-research", res.source === "openai" || res.source === "grok" ? "ok" : "fail");
    } catch (e) {
      appendLog("API", "Netzwerk-Fehler: " + e);
      setStatus("test-research", "fail");
    }
  }

  async function fetchIdeaGrok() {
    setStatus("test-grok", "running");
    try {
      const res = await postJSON("/api/research/idea", {risk:3, budget_sol:0.1, provider:"grok"});
      addIdea(res);
      appendLog("API", `Grok: ${res.source} | Retries: ${res.retries || 0} | Dauer: ${res.duration_ms || 0}ms`);
      if (res.error) appendLog("API", `Grok Fehler: ${res.error}`);
      setStatus("test-grok", (res.source === "grok" || res.source.startsWith("grok")) ? "ok" : "fail");
    } catch (e) {
      appendLog("API", "Grok Netzwerk-Fehler: " + e);
      setStatus("test-grok", "fail");
    }
  }

  async function fetchIdeaOpenAI() {
    setStatus("test-openai", "running");
    try {
      const res = await postJSON("/api/research/idea", {risk:3, budget_sol:0.1, provider:"openai"});
      addIdea(res);
      appendLog("API", `OpenAI: ${res.source} | Retries: ${res.retries || 0} | Dauer: ${res.duration_ms || 0}ms`);
      if (res.error) appendLog("API", `OpenAI Fehler: ${res.error}`);
      setStatus("test-openai", (res.source === "openai" || res.source.startsWith("openai")) ? "ok" : "fail");
    } catch (e) {
      appendLog("API", "OpenAI Netzwerk-Fehler: " + e);
      setStatus("test-openai", "fail");
    }
  }

  async function testGrokConnectivity() {
    setStatus("test-grok-connect", "running");
    try {
      const res = await getJSON("/api/research/test/grok");
      appendLog("Grok Test", `Status: ${res.status} | Source: ${res.source}`);
      if (res.ok && res.response) {
        appendLog("Grok Test", `Response: ${JSON.stringify(res.response)}`);
        setStatus("test-grok-connect", "ok");
      } else {
        appendLog("Grok Test", `Error: ${res.error}`);
        setStatus("test-grok-connect", "fail");
      }
    } catch (e) {
      appendLog("Grok Test", "Netzwerk-Fehler: " + e);
      setStatus("test-grok-connect", "fail");
    }
  }

  async function fetchStaticIdea() {
    setStatus("test-static", "running");
    try {
      const res = await getJSON("/api/idea");
      addStaticIdea(res);
      appendLog("API", "Statische Idee geladen");
      setStatus("test-static", "ok");
    } catch (e) {
      appendLog("API", "Fehler /api/idea: " + e);
      setStatus("test-static", "fail");
    }
  }

  async function fetchAnalysis() {
    setStatus("test-analysis", "running");
    try {
      const res = await getJSON("/api/analysis");
      addAnalysis(res);
      appendLog("API", "Analyse geladen");
      setStatus("test-analysis", "ok");
    } catch (e) {
      appendLog("API", "Fehler /api/analysis: " + e);
      setStatus("test-analysis", "fail");
    }
  }

  async function pingHealth(){
    try {
      const res = await getJSON("/api/research/health");
      appendLog("Health", JSON.stringify(res, null, 2));
      document.getElementById("timeout-val").textContent = res.timeout_s + "s";
      setStatus("test-health", res.ok ? "ok" : "fail");
    } catch (e) {
      appendLog("Health", "Fehler: " + e);
      setStatus("test-health", "fail");
    }
  }

  function setStatus(id, state){
    const el = document.getElementById(id);
    el.textContent = state.toUpperCase();
    el.className = "status " + state;
  }

  function appendLog(title, text){
    const log = document.getElementById("log");
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${title}: ${text}\n`;
    log.scrollTop = log.scrollHeight;
  }

  function addIdea(res){
    const wrap = document.getElementById("ideas");
    const div = document.createElement("div");
    div.className = "idea";

    // Determine badge style based on source
    let sourceClass = "fallback";
    let displaySource = res.source.toUpperCase();

    if (res.source === "openai" || res.source.startsWith("openai")) {
      sourceClass = "openai";
      displaySource = "OPENAI";
    } else if (res.source === "grok" || res.source.startsWith("grok")) {
      sourceClass = "grok";
      displaySource = "GROK";
    } else if (res.source === "fallback") {
      sourceClass = "fallback";
      displaySource = "FALLBACK";
    } else if (res.source === "error") {
      sourceClass = "error";
      displaySource = "ERROR";
    } else {
      sourceClass = "fallback";
      displaySource = res.source.toUpperCase();
    }

    div.innerHTML = `
      <div class="row">
        <b>${res.payload.asset}</b>
        <span class="source-badge ${sourceClass}">${displaySource}</span>
      </div>
      <small>${res.payload.thesis}</small><br>
      <code>${res.payload.entry_rule}</code> ‚Üí <code>${res.payload.exit_rule}</code>
      <div class="meta-info">
        Risk: ${res.payload.risk} | Budget: ${res.payload.budget_sol} SOL |
        TTL: ${res.payload.ttl_minutes}min | Retries: ${res.retries || 0} |
        Duration: ${res.duration_ms || 0}ms
      </div>
      ${res.error ? `<div class="meta-info" style="color:#ff7780;">Error: ${res.error}</div>` : ''}
    `;
    wrap.prepend(div);
  }

  function addStaticIdea(res){
    const wrap = document.getElementById("ideas");
    const div = document.createElement("div");
    div.className = "idea";
    div.innerHTML = `
      <div class="row">
        <b>Statische Idee</b>
        <span class="source-badge fallback">STATIC</span>
      </div>
      <small>${res.idea}</small><br>
      <em>Rohdaten: ${res.file_content}</em>
    `;
    wrap.prepend(div);
  }

  function addAnalysis(res){
    const wrap = document.getElementById("ideas");
    const div = document.createElement("div");
    div.className = "idea";
    div.innerHTML = `
      <div class="row">
        <b>Analyse</b>
        <span class="source-badge fallback">STATIC</span>
      </div>
      <small>${res.analysis}</small><br>
      <em>Rohdaten: ${res.file_content}</em>
    `;
    wrap.prepend(div);
  }

  window.addEventListener("DOMContentLoaded", () => {
    pingHealth();
  });
</script>
<div class="layout">
  <aside class="sidebar">
    <div style="margin-bottom: 16px;">
      <a href="index.html" style="background: var(--accent); color: #0b1020; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block; font-size: 12px;">üè† Dashboard</a>
    </div>
    <h1>üöÄ Enhanced API Demo</h1>
    <div class="section-title">Einzeltsts</div>
    <button class="btn" onclick="runIdeaUnitTest()">Idea Test (pytest)</button>
    <div class="section-title">API Tests mit Fallback</div>
    <button class="btn" onclick="pingHealth()">Health pr√ºfen<span class="tag" id="test-health">-</span></button>
    <button class="btn" onclick="fetchIdea()">/api/research/idea (auto)<span class="tag" id="test-research">-</span></button>
    <button class="btn" onclick="fetchIdeaGrok()">/api/research/idea (Grok)<span class="tag" id="test-grok">-</span></button>
    <button class="btn" onclick="fetchIdeaOpenAI()">/api/research/idea (OpenAI)<span class="tag" id="test-openai">-</span></button>
    <button class="btn" onclick="testGrokConnectivity()">/api/research/test/grok<span class="tag" id="test-grok-connect">-</span></button>
    <button class="btn" onclick="fetchStaticIdea()">/api/idea (static)<span class="tag" id="test-static">-</span></button>
    <button class="btn" onclick="fetchAnalysis()">/api/analysis<span class="tag" id="test-analysis">-</span></button>
    <div class="section-title">Konfiguration</div>
    <div class="status" id="summary-path">Report/summaryYY-MM-DD.txt</div>
    <div class="section-title">Timeout</div>
    <div class="status" id="timeout-val">-</div>
    <div class="section-title">Features</div>
    <div style="font-size:11px; color:#99a3ad; line-height:1.4;">
      ‚úÖ Multi-Provider Support (OpenAI + xAI Grok)<br>
      ‚úÖ Retry bei 429/Quota & Rate-Limits<br>
      ‚úÖ Backoff-Mechanismus<br>
      ‚úÖ Cross-Provider Fallback<br>
      ‚úÖ Endpoint Auto-Discovery (25+ Kombinationen)<br>
      ‚úÖ Multi-Model Support (grok-3, grok-4, grok-3-mini, etc.)<br>
      ‚úÖ Einfacher Konnektivit√§tstest<br>
      ‚úÖ Detaillierte Fehlerberichte<br>
      ‚úÖ Performance-Metriken<br>
      ‚úÖ Provider-spezifische Tests<br>
      <br>
      <a href="index.html" style="color: var(--accent); text-decoration: none;">üîó Zum Haupt-Dashboard</a>
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <div class="cards">
        <div class="card">
          <div class="row"><h3>üìã Protokoll & Logs</h3></div>
          <div class="log" id="log"></div>
        </div>
        <div class="card">
          <div class="row"><h3>üí° Ideen & Analysen</h3></div>
          <div id="ideas">
            <div class="idea" style="border-style:solid; background:#0a0f1a;">
              <b>Demo-Hinweise:</b><br>
              <small>‚Ä¢ Gr√ºne Badges = OpenAI erfolgreich<br>‚Ä¢ Lila Badges = Grok erfolgreich<br>‚Ä¢ Orange Badges = Fallback aktiv<br>‚Ä¢ Rote Badges = Fehler<br>‚Ä¢ Alle Requests werden mitgeloggt</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>